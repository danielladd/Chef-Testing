
#! /bin/bash

## Determine day of week. If Sunday, do an archival backup.
## Otherwise, do by day of week.

DOW=`/bin/date +%a`
REPLSET="mysqldump"

if [ $DOW == "Sun" ]; then
        DSTRING=`/bin/date +%Y-%m-%d`
        ARCHSTRING="$REPLSET.$DOW.$DSTRING.tgz"
else
        ARCHSTRING="$REPLSET.$DOW"
fi

BACKUP_DIR="<%= node[:mysql][:backup_root_path] %>/$ARCHSTRING"

CRON="backup.$ARCHSTRING"
LOCKFILE="/tmp/cron.$CRON.lock"

if [ -f "$LOCKFILE" ]; then
        /usr/bin/logger -t mysql_backup "$ARCHSTRING locked; skipping"
        exit 0
fi

touch "$LOCKFILE"
/usr/bin/logger -t mysql_backup "$ARCHSTRING started"
rm -f $BACKUP_DIR
mkdir -p $BACKUP_DIR
mysqldump --user=root --password=<%= node[:mysql][:server_root_password] %> --all-databases > $BACKUP_DIR/dump.sql
rm -f "$LOCKFILE"
/usr/bin/logger -t mysql_backup "$ARCHSTRING finished"
